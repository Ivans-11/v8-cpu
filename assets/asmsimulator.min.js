/*! asmsimulator 22-10-2025 */
function log(a){setTimeout(function(){throw new Error(a)},0)}var app=angular.module("ASMSimulator",[]);app.service("uploader",["opcodes",function(a){return{go:function(a){for(var b=[],c=[],d={},e={},f=a.split("\n"),g=0,h=f.length;h>g;g++){var i=f[g],j=i.indexOf(";");j>0?i=i.slice(0,j-1):0===j&&(i="");for(var k=i.split(" "),l=0,m=k.length;m>l;l++)if(""!==k[l])for(var n=1;n<k[l].length;n+=2){var o=parseInt(k[l].slice(n-1,n+1),16);if(0>o||o>255)throw{error:"code must be a value between 0...255"};b.push(o)}}return{code:b,disk:c,mapping:d,labels:e}}}}]),app.service("assembler",["opcodes",function(a){return{go:function(b){for(var c=/^[\t ]*(?:([.A-Za-z]\w*)(@\w+)?[:])?(?:[\t ]*([A-Za-z]{2,6})(?:[\t ]+([-.A-Za-z0-9]\w*((\+|-)\d+)?)(?:[\t ]*[,][\t ]*([-.A-Za-z0-9]\w*((\+|-)\d+)?)(?:[\t ]*[,][\t ]*([-.A-Za-z0-9]\w*((\+|-)\d+)?))?)?)?)?/,d=4,e=7,f=10,g=/^[-+]?[0-9]+$/,h=/^([.A-Za-z_]\w*)((\+|-)\d+)?$/,i=[],j=[],k=0,l={},m={},n={},o=!1,p=b.split("\n"),q=function(a){return"0x"===a.slice(0,2)?parseInt(a.slice(2),16):g.exec(a)?255&parseInt(a,10):void 0},r=function(a){return a=a.toUpperCase(),"R0"===a?0:"R1"===a?1:"R2"===a?2:"R3"===a?3:"R4"===a?4:"R5"===a?5:"R6"===a?6:"R7"===a?7:"R8"===a?8:"R9"===a?9:"RA"===a?10:"RB"===a?11:"RC"===a?12:"RD"===a?13:"RE"===a?14:"RF"===a?15:void 0},s=function(a){var b=q(a);if(void 0!==b){if(b>=0&&255>=b)return b;throw"addresses must have a value between 0-255"}var c=h.exec(a);if(void 0===c[1])return void 0;var d=0;if(void 0!==c[2]){var e="-"===c[2][0]?-1:1;d=e*parseInt(c[2].slice(1),10)}return{label:c[1],offset:d}},t=(function(a,b){var c=a.toUpperCase();if(c in n)throw"Duplicate label: "+a;if(void 0===b)m[a]=k;else{if(!(b>=0&&255>=b))throw"addresses must have a value between 0-255";for(m[a]=b,k=b;i.length<k;)i.push(0)}}),u=function(a,b){if(void 0!==b)throw a+": too many arguments"},v=function(){for(var a in arguments){var b=arguments[a];if(0>k||k>255)throw"Too many code/data";k==i.length?i.push(b):k<i.length&&(i[k]=b),k+=1}},w=0,x=p.length;x>w;w++){var y=p[w].trim();if(""!==y&&";"!=y.slice(0,1))if(o)for(var z=y.split(" "),A=0,B=z.length;B>A;A++)""!==z[A]&&j.push(parseInt(z[A],16)%256);else if("=========="!==y)try{var C=c.exec(p[w]);if(void 0===C[1]&&void 0===C[3])throw"Syntax error";if(void 0!==C[1]){var D=C[2];void 0!==D&&(D=q(D.slice(1))),t(C[1],D)}if(void 0!==C[3]){var E,F,G,H=C[3].toUpperCase();switch("DB"!==H&&(l[k]=w),H){case"DB":if(E=q(C[d]),void 0===E)throw"DB does not support this operand";v(255&E);break;case"HALT":u("HALT",C[d]),u("HALT",C[e]),u("HALT",C[f]),v(a.HALT<<4,0);break;case"MOVE":if(E=r(C[d]),F=r(C[e]),u("MOVE",C[f]),void 0===E||void 0===F)throw"MOVE does not support this operands";v(a.MOVE<<4,F<<4|E);break;case"ADDI":if(E=r(C[d]),F=r(C[e]),G=r(C[f]),void 0===E||void 0===F||void 0===G)throw"ADDI does not support this operands";v(a.ADD_INT<<4|E,F<<4|G);break;case"ADDF":if(E=r(C[d]),F=r(C[e]),G=r(C[f]),void 0===E||void 0===F||void 0===G)throw"ADDF does not support this operands";v(a.ADD_FLOAT<<4|E,F<<4|G);break;case"LOADM":if(E=r(C[d]),F=s(C[e]),u("LOADM",C[f]),void 0===E||void 0===F)throw"LOADM does not support this operands";v(a.LOAD_FROM_MEMORY<<4|E,F);break;case"LOADB":if(E=r(C[d]),F=s(C[e]),u("LOADB",C[f]),void 0===E||void 0===F)throw"LOADB does not support this operands";v(a.LOAD_WITH_CONSTANT<<4|E,F);break;case"LOADP":if(E=r(C[d]),F=r(C[e]),u("LOADP",C[f]),void 0===E||void 0===F)throw"LOADP does not support this operands";v(a.LOAD_FROM_POINTER<<4|E,F);break;case"STOREM":if(E=r(C[d]),F=s(C[e]),u("STOREM",C[f]),void 0===E||void 0===F)throw"STOREM does not support this operands";v(a.STORE_TO_MEMORY<<4|E,F);break;case"STOREP":if(E=r(C[d]),F=r(C[e]),u("STOREP",C[f]),void 0===E||void 0===F)throw"STOREP does not support this operands";v(a.STORE_TO_POINTER<<4|E,F);break;case"JUMP":if(E=r(C[d]),F=s(C[e]),u("JUMP",C[f]),void 0===E||void 0===F)throw"JUMP does not support this operands";v(a.JUMP_IF_EQUAL<<4|E,F);break;case"JUMPL":if(E=r(C[d]),F=s(C[e]),u("JUMPL",C[f]),void 0===E||void 0===F)throw"JUMPL does not support this operands";v(a.JUMP_IF_LESS<<4|E,F);break;case"AND":if(E=r(C[d]),F=r(C[e]),G=r(C[f]),void 0===E||void 0===F||void 0===G)throw"AND does not support this operands";v(a.AND<<4|E,F<<4|G);break;case"OR":if(E=r(C[d]),F=r(C[e]),G=r(C[f]),void 0===E||void 0===F||void 0===G)throw"OR does not support this operands";v(a.OR<<4|E,F<<4|G);break;case"XOR":if(E=r(C[d]),F=r(C[e]),G=r(C[f]),void 0===E||void 0===F||void 0===G)throw"XOR does not support this operands";v(a.XOR<<4|E,F<<4|G);break;case"ROT":if(E=r(C[d]),F=q(C[e]),u("ROT",C[f]),void 0===E||void 0===F)throw"LOADB does not support this operands";v(a.ROTATE<<4|E,F);break;default:throw"Invalid instruction: "+C[2]}}}catch(I){throw{error:I,line:w}}else o=!0}for(w=0,x=i.length;x>w;w++)if(!angular.isNumber(i[w])){var J=i[w];if(!(J.label in m))throw{error:"Undefined label: "+J.label};i[w]=m[J.label]+J.offset&255}return{code:i,disk:j,mapping:l,labels:m}}}}]),app.service("cpu",["opcodes","memory",function(a,b){var c={step:function(){var c=this,d=function(a){return 128>a?a:a-255},e=function(a){return c.gpr[a]},f=function(a,b){c.gpr[a]=b,15==a&&(c.updateTimer=!0,b>0?c.countdown=b:c.countdown=0)},g=function(a,b){var c;for(c=b;c>=0&&a>>c===0;c--);return c},h=function(a,b){var c,d,e=(128&a)>>7,f=(112&a)>>4,h=15&a,i=(128&b)>>7,j=(112&b)>>4,k=15&b,l=h<<f,m=k<<j;e==i?(c=e,d=l+m):l>m?(c=e,d=l-m):m>l?(c=i,d=m-l):(d=0,c=0);var n=g(d,16)-3;n>7?n=7:0>n&&(n=0);var o=d>>n&15,p=c<<7|n<<4|o;return p},i=function(a){c.ir="",a[0]<=15?c.ir+="0"+a[0].toString(16):c.ir+=a[0].toString(16),a[1]<=15?c.ir+="0"+a[1].toString(16):c.ir+=a[1].toString(16)};c.updateTimer=!1,c.status="";var j=[b.load(c.ip),b.load(c.ip+1)],k=j[0]>>4,l=15&j[0],m=j[1]>>4,n=15&j[1],o=j[1],p=j[1];switch(i(j),c.ip=c.ip+2&255,k){case a.LOAD_FROM_MEMORY:f(l,b.load(o));break;case a.LOAD_WITH_CONSTANT:f(l,p);break;case a.STORE_TO_MEMORY:b.store(o,e(l));break;case a.MOVE:f(n,e(m));break;case a.ADD_INT:f(l,e(m)+e(n)&255);break;case a.ADD_FLOAT:f(l,h(e(m),e(n)));break;case a.OR:f(l,e(m)|e(n));break;case a.AND:f(l,e(m)&e(n));break;case a.XOR:f(l,e(m)^e(n));break;case a.ROTATE:var q=p%8,r=e(l);f(l,(r>>q)+((r&(1<<q)-1)<<8-q));break;case a.JUMP_IF_EQUAL:e(l)==e(0)&&(c.ip=o);break;case a.HALT:return c.ip=c.ip-2&255,!1;case a.LOAD_FROM_POINTER:f(l,b.load(e(n)));break;case a.STORE_TO_POINTER:b.store(e(n),e(l));break;case a.JUMP_IF_LESS:d(e(l))<d(e(0))&&(c.ip=o)}return c.countdown>0&&!c.updateTimer&&(c.countdown-=1,0===c.countdown&&(b.store(253,c.ip),c.ip=128,c.countdown=e(15),c.status="(Interrupted!)")),!0},reset:function(){var a=this;a.gpr=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],a.ip=0,a.ir="0000",a.status="",a.countdown=0,a.updateTimer=!1}};return c.reset(),c}]),app.service("memory",["printer",function(a){var b={data:Array(256),lastAccess:-1,diskdata:Array(256),statusnow:0,sector_address:0,memory_address:0,disk_operation:0,disk_latency:0,sectorlength:16,load:function(b){var c=this;if(0>b||b>=c.data.length)throw"Memory access violation at "+b;if(c.lastAccess=b,254==b)return a.load();if(255==b){if(c.disk_latency>0)return c.disk_latency=c.disk_latency-1,0;if(0===c.disk_operation)for(var d=0;d<c.sectorlength;d++)c.data[c.memory_address+d]=c.diskdata[c.sector_address*c.sectorlength+d];else if(1===c.disk_operation)for(var e=0;e<c.sectorlength;e++)c.diskdata[c.sector_address*c.sectorlength+e]=c.data[c.memory_address+e];return c.statusnow=0,c.sector_address=0,c.memory_address=0,255}return c.data[b]},store:function(b,c){var d=this;if(0>b||b>=d.data.length)throw"Memory access violation at "+b;return d.lastAccess=b,254==b?a.store(c):255==b?void(0===d.statusnow?(d.statusnow=1,d.sector_address=c):1===d.statusnow?(d.statusnow=2,d.memory_address=c):2===d.statusnow&&(d.disk_operation=c,d.disk_latency=3)):void(d.data[b]=c)},reset:function(){var a=this;a.lastAccess=-1,a.statusnow=0,a.sector_address=0,a.memory_address=0,a.disk_operation=0,a.disk_latency=0;for(var b=0,c=a.data.length;c>b;b++)a.data[b]=0;for(b=0;b<a.diskdata.length;b++)a.diskdata[b]=0}};return b.reset(),b}]),app.service("opcodes",[function(){var a={NONE:0,LOAD_FROM_MEMORY:1,LOAD_WITH_CONSTANT:2,STORE_TO_MEMORY:3,MOVE:4,ADD_INT:5,ADD_FLOAT:6,OR:7,AND:8,XOR:9,ROTATE:10,JUMP_IF_EQUAL:11,HALT:12,LOAD_FROM_POINTER:13,STORE_TO_POINTER:14,JUMP_IF_LESS:15};return a}]),app.service("printer",[function(){var a={data:"",load:function(){return 0},store:function(a){var b=this;16>a?b.data+="0"+a.toString(16).toUpperCase()+" ":b.data+=a.toString(16).toUpperCase()+" "},reset:function(){var a=this;a.data=""}};return a.reset(),a}]),app.controller("Ctrl",["$document","$scope","$timeout","$http","cpu","memory","printer","assembler","uploader",function(a,b,c,d,e,f,g,h,i){b.printer=g,b.memory=f,b.cpu=e,b.error="",b.isRunning=!1,b.displayHex=!0,b.displayInstr=!0,b.displayA=!1,b.displayB=!1,b.displayC=!1,b.displayD=!1,b.speeds=[{speed:1,desc:"1 HZ"},{speed:4,desc:"4 HZ"},{speed:8,desc:"8 HZ"},{speed:16,desc:"16 HZ"}],b.speed=4,b.example="",b.examples=[],b.code=";; Choose an example above or write your own code here :)",b.reset=function(){e.reset(),f.reset(),g.reset(),b.error="",b.selectedLine=-1,b.mapping=void 0},b.executeStep=function(){b.checkPrgrmLoaded()||b.assemble();try{var a=e.step();return e.ip in b.mapping&&(b.selectedLine=b.mapping[e.ip]),a}catch(c){return b.error=c,!1}};var j;b.run=function(){b.checkPrgrmLoaded()||b.assemble(),b.isRunning=!0,j=c(function(){b.executeStep()===!0?b.run():b.isRunning=!1},1e3/b.speed)},b.stop=function(){c.cancel(j),b.isRunning=!1},b.checkPrgrmLoaded=function(){for(var a=0,b=f.data.length;b>a;a++)if(0!==f.data[a])return!0;return!1},b.getChar=function(a){var b=String.fromCharCode(a);return""===b.trim()?"  ":b},b.assemble=function(){try{b.reset();var a=h.go(b.code);b.mapping=a.mapping;var c=a.code,d=a.disk;if(b.labels=a.labels,c.length>f.data.length)throw{error:"Binary code does not fit into the memory. Max "+f.data.length+" bytes are allowed"};if(d.length>f.diskdata.length)throw{error:"Disk data does not fit into the disk. Max "+f.diskdata.length+" bytes are allowed"};for(var g=0,i=c.length;i>g;g++)f.data[g]=c[g];for(g=0,i=d.length;i>g;g++)f.diskdata[g]=d[g];void 0!==b.labels[".entry"]&&(e.ip=b.labels[".entry"])}catch(j){void 0!==j.line?(b.error=j.line+" | "+j.error,b.selectedLine=j.line):b.error=j.error}},b.upload=function(){try{b.reset();var a=i.go(b.code);b.mapping=a.mapping;var c=a.code;if(b.labels=a.labels,c.length>f.data.length)throw"Binary code does not fit into the memory. Max "+f.data.length+" bytes are allowed";for(var d=0,e=c.length;e>d;d++)f.data[d]=c[d]}catch(g){void 0!==g.line?(b.error=g.line+" | "+g.error,b.selectedLine=g.line):b.error=g.error}},b.compile=function(){d.post("/",{source:b.code}).success(function(a){b.code=a,b.assemble()})},b.initExamples=function(){d.get("examples/examples.json").then(function(a){for(var c=a.data,d=0;d<c.length;d++){var e=c[d].split("|"),f=e[0],g=e[1];b.examples.push({id:f,desc:g})}},function(a){console.error("Failed to load examples.json",a)})},b.showExample=function(a){var c=d.get("examples/"+b.example);c.success(function(a,c,d,e){b.code=a}),c.error(function(a,b,c,d){console.error("ajax failed")})},b.jumpToLine=function(c){a[0].getElementById("sourceCode").scrollIntoView(),b.selectedLine=b.mapping[c]},b.isInstruction=function(a){return void 0!==b.mapping&&void 0!==b.mapping[a]&&b.displayInstr},b.getMemoryCellCss=function(a){return b.isInstruction(a)?"instr-bg":""},b.getMemoryInnerCellCss=function(a){return a===e.ip?"marker marker-ip":a===e.sp?"marker marker-sp":a===e.gpr[0]&&b.displayA?"marker marker-a":a===e.gpr[1]&&b.displayB?"marker marker-b":a===e.gpr[2]&&b.displayC?"marker marker-c":a===e.gpr[3]&&b.displayD?"marker marker-d":""}}]),app.filter("flag",function(){return function(a){return a.toString().toUpperCase()}}),app.filter("number",function(){return function(a,b){if(0===a||void 0===a)return"00";if(b){var c=a.toString(16).toUpperCase();return 1==c.length?"0"+c:c}return a.toString(10)}}),app.directive("selectLine",[function(){return{restrict:"A",link:function(a,b,c,d){a.$watch("selectedLine",function(){if(a.selectedLine>=0){for(var c=b[0].value.split("\n"),d=0,e=0;e<c.length&&e!=a.selectedLine;e++)d+=c[e].length+1;var f=c[a.selectedLine].length+d;if("undefined"!=typeof b[0].selectionStart&&(b[0].focus(),b[0].selectionStart=d,b[0].selectionEnd=f),document.selection&&document.selection.createRange){b[0].focus(),b[0].select();var g=document.selection.createRange();g.collapse(!0),g.moveEnd("character",f),g.moveStart("character",d),g.select()}}})}}}]),app.filter("startFrom",function(){return function(a,b){return b=+b,a.slice(b)}}),app.directive("tabSupport",[function(){return{restrict:"A",link:function(a,b,c,d){b.bind("keydown",function(a){if(9===a.keyCode){var b=this.value,c=this.selectionStart,d=this.selectionEnd;return this.value=b.substring(0,c)+"	"+b.substring(d),this.selectionStart=this.selectionEnd=c+1,a.preventDefault(),!1}})}}}]);